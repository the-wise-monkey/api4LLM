services:
  api4llm:
    container_name: api4llm
    restart: unless-stopped

    build: ./CLIProxyAPI
    image: api4llm:latest

    ports:
      - "8317:8317"
      - "54545:54545"  # Claude OAuth callback port

    volumes:
      # Config file mount
      - type: bind
        source: ./config.yaml
        target: /CLIProxyAPI/config.yaml

      # Persistent auth/token storage (fixes mkdir crash)
      - type: bind
        source: ./data
        target: /CLIProxyAPI/data

    environment:
      - TZ=America/Montevideo

  diagnostics:
    container_name: api4llm-diagnostics
    restart: unless-stopped

    build:
      context: .
      dockerfile: diagnostics/Dockerfile
    image: api4llm-diagnostics:latest

    depends_on:
      - api4llm

    ports:
      - "127.0.0.1:9321:9321"

    volumes:
      - type: bind
        source: ./config.yaml
        target: /app/config.yaml
        read_only: true
      - type: bind
        source: ./data
        target: /app/data
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock

    environment:
      - DIAG_ALLOW_REMOTE=true
      - DIAG_CONFIG_FILE=/app/config.yaml
      - DIAG_CONTAINER=api4llm
      - DIAG_DATA_DIR=/app/data
      - DIAG_DOCKER_MODE=container
      - DIAG_HOST=0.0.0.0
      - DIAG_PORT=9321
      - DIAG_SERVICE=api4llm
